<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annuaire Mods & Plugins - CraftKit</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased min-h-screen">
                                
    <!-- Navbar -->
    <header class="bg-gray-800 shadow-lg sticky top-0 z-10">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <svg class="w-8 h-8 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 100 4m-3 12h2m-6-10h4m-2 4h4m-2 4h2M5 16h2m10 0h2m-6 4a2 2 0 100 4m-3-12h2m-6 0h4m-2 4h4m-2 4h2"></path></svg>
                <span class="text-2xl font-extrabold text-white">Craft<span class="text-yellow-400">Kit</span></span>
            </a>
            <div class="space-x-4">
                <a href="mods_plugins.html" class="px-4 py-2 text-yellow-400 font-semibold rounded-lg bg-gray-700/50 transition duration-300 text-sm hidden sm:inline-block">Annuaire Mods</a>
                <a href="login.html" class="px-4 py-2 bg-yellow-500 text-gray-900 rounded-lg font-semibold hover:bg-yellow-400 transition duration-300 text-sm">Connexion</a>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-4xl font-extrabold text-white mb-8 text-center">Annuaire Connecté Modrinth</h1>

        <!-- Bar de Recherche et Filtres -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <input type="text" id="searchInput" placeholder="Rechercher par nom..." 
                   class="flex-grow p-3 rounded-lg bg-gray-800 border border-gray-700 focus:border-yellow-500 focus:ring focus:ring-yellow-500/50 text-white placeholder-gray-500">
            
            <!-- Filtre pour la Version de Minecraft -->
            <select id="versionFilter" class="p-3 rounded-lg bg-gray-800 border border-gray-700 text-white">
                <option value="">Version (Toutes)</option>
                <option value="1.21">1.21</option>
                <option value="1.20.6">1.20.6</option>
                <option value="1.20.4">1.20.4</option>
                <option value="1.20.1">1.20.1</option>
                <option value="1.19.4">1.19.4</option>
                <option value="1.19.2">1.19.2</option>
                <option value="1.18.2">1.18.2</option>
                <option value="1.16.5">1.16.5</option>
                <option value="1.12.2">1.12.2</option>
            </select>

            <!-- Filtre pour le Type de Chargeur/Plateforme (Détaillé) -->
            <select id="loaderFilter" class="p-3 rounded-lg bg-gray-800 border border-gray-700 text-white">
                <option value="">Type de Serveur (Tous)</option>
                <option value="fabric">Fabric (Modding Client/Serveur)</option>
                <option value="forge">Forge (Modding Client/Serveur)</option>
                <option value="neoforge">NeoForge (Modding Client/Serveur)</option>
                <option value="quilt">Quilt (Modding Client/Serveur)</option>
                <option value="paper">Paper/Spigot (Serveur Plugin)</option>
                <option value="bukkit">Bukkit (Serveur Plugin)</option>
                <option value="spigot">Spigot (Serveur Plugin)</option>
                <option value="bungeecord">Bungeecord (Proxy Réseau)</option>
                <option value="velocity">Velocity (Proxy Réseau)</option>
            </select>
            
            <!-- Filtre pour le Type de Projet (Mod, Plugin, Modpack) -->
            <select id="typeFilter" class="p-3 rounded-lg bg-gray-800 border border-gray-700 text-white">
                <option value="">Type de Projet (Tous)</option>
                <option value="mod">Mod (Client/Forge/Fabric...)</option>
                <option value="plugin">Plugin (Spigot/Paper...)</option>
                <option value="modpack">Modpack</option>
            </select>
        </div>

        <!-- Zone d'Affichage des Mods -->
        <div id="modsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Les cartes de mods seront insérées ici par JavaScript -->
        </div>

        <!-- Indicateur de Chargement / Bouton de Chargement (pour l'infini scroll) -->
        <div class="text-center mt-12" id="loadingArea">
            <button id="loadMoreButton" class="px-6 py-3 bg-yellow-500 text-gray-900 font-bold rounded-xl shadow-lg hover:bg-yellow-400 transition duration-300 hidden">
                Charger Plus de Mods
            </button>
            <p id="loadingIndicator" class="text-gray-400">
                Chargement des premiers mods...
            </p>
        </div>
        
    </main>

    <!-- Footer -->
    <footer class="bg-gray-900 border-t border-gray-700/50 py-8 mt-12">
        <div class="container mx-auto px-4 text-center text-gray-500">
            <p>&copy; 2025 CraftKit. Propulsé par la communauté Minecraft. Données de l'annuaire fournies par Modrinth.</p>
        </div>
    </footer>

    <script>
        // Constants et Variables globales
        const MODRINTH_API = "https://api.modrinth.com/v2/search";
        const MODS_PER_PAGE = 20; 
        let currentPage = 0;
        let isFetching = false;

        // Éléments DOM
        const modsContainer = document.getElementById('modsContainer');
        const searchInput = document.getElementById('searchInput');
        const versionFilter = document.getElementById('versionFilter');
        const loaderFilter = document.getElementById('loaderFilter');
        const typeFilter = document.getElementById('typeFilter'); 
        
        const loadMoreButton = document.getElementById('loadMoreButton');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Fonction d'aide pour la temporisation (Exponential Backoff pour l'API)
        async function fetchWithBackoff(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.error(`Tentative ${i + 1} échouée. Nouvelle tentative dans ${delay}ms...`, error);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Double le délai pour le prochain essai
                }
            }
        }

        /**
         * Construit une carte HTML pour un mod/plugin.
         */
        function createModCard(mod) {
            const card = document.createElement('a');
            card.href = `https://modrinth.com/project/${mod.slug}`;
            card.target = "_blank";
            card.className = "block bg-gray-800 rounded-xl shadow-2xl p-4 transition duration-300 hover:bg-gray-700/70 transform hover:scale-[1.02]";

            const iconUrl = mod.icon_url || 'https://placehold.co/64x64/2d3748/fff?text=MK';
            
            const dateUpdate = new Date(mod.date_modified).toLocaleDateString('fr-FR', {
                year: 'numeric', month: 'short', day: 'numeric'
            });

            // Utilisation de (mod.game_versions || []) pour éviter l'erreur de "slice"
            const platformTags = (mod.game_versions || []).slice(0, 3).map(v => 
                `<span class="inline-block bg-gray-700 text-xs font-semibold px-2 py-1 rounded-full">${v}</span>`
            ).join('');

            card.innerHTML = `
                <div class="flex items-start space-x-4 mb-4">
                    <img src="${iconUrl}" onerror="this.onerror=null; this.src='https://placehold.co/64x64/2d3748/fff?text=MK';" class="w-16 h-16 rounded-lg object-cover" alt="Icône de ${mod.title}">
                    <div class="flex-grow text-left">
                        <h3 class="text-lg font-bold text-yellow-400 group-hover:text-yellow-300">${mod.title}</h3>
                        <p class="text-sm text-gray-400">${mod.project_type.charAt(0).toUpperCase() + mod.project_type.slice(1)}</p>
                    </div>
                </div>
                <p class="text-gray-300 text-sm line-clamp-2 mb-3 h-10">${mod.description}</p>
                <div class="text-xs text-gray-500 mb-3 flex justify-between items-center">
                    <span>${mod.downloads} Téléchargements</span>
                    <span>Mis à jour: ${dateUpdate}</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    ${platformTags}
                </div>
            `;
            return card;
        }

        /**
         * Construit l'URL de recherche pour Modrinth avec tous les filtres.
         */
        function buildQueryUrl(offset, limit, query, version, loader, type) {
            let url = new URL(MODRINTH_API);
            let facets = [];

            // 1. Facette pour le Type de Projet (Mod, Plugin, Modpack) - OR logic
            let projectTypes = [];
            if (type) {
                projectTypes.push(`project_type:${type}`);
            } else {
                projectTypes.push("project_type:mod", "project_type:plugin", "project_type:modpack");
            }
            if (projectTypes.length > 0) {
                facets.push(projectTypes);
            }
            
            // 2. Facette pour la Version de Minecraft - AND logic
            if (version) {
                facets.push([`versions:${version}`]);
            }

            // 3. Facette pour le Type de Chargeur/Plateforme (Loader/Category) - AND logic
            if (loader) {
                // Remarque : Modrinth utilise 'categories' pour tous les types de chargeurs/plateformes
                facets.push([`categories:${loader}`]);
            }

            // Construction finale de la chaîne de facettes, encodée en JSON.
            const facetString = JSON.stringify(facets);

            // Paramètres de l'API
            url.searchParams.set('offset', offset);
            url.searchParams.set('limit', limit);
            url.searchParams.set('index', 'downloads'); // Tri par popularité (downloads)
            url.searchParams.set('query', query || '');
            url.searchParams.set('facets', facetString);
            
            return url.toString();
        }

        /**
         * Charge les mods depuis l'API Modrinth et les affiche.
         */
        async function loadMods(clear = false) {
            if (isFetching) return;
            isFetching = true;
            loadingIndicator.textContent = clear ? "Chargement des premiers mods..." : "Chargement en cours...";
            loadMoreButton.classList.add('hidden');
            
            if (clear) {
                modsContainer.innerHTML = '';
                currentPage = 0;
            }

            const query = searchInput.value.trim();
            const version = versionFilter.value;
            const loader = loaderFilter.value;
            const type = typeFilter.value;

            // Construit l'URL
            const url = buildQueryUrl(currentPage * MODS_PER_PAGE, MODS_PER_PAGE, query, version, loader, type);

            try {
                const data = await fetchWithBackoff(url);
                
                if (data.hits && data.hits.length > 0) {
                    data.hits.forEach(mod => {
                        modsContainer.appendChild(createModCard(mod));
                    });
                    currentPage++;
                    
                    if (data.hits.length < MODS_PER_PAGE) {
                         loadingIndicator.textContent = "Fin des résultats.";
                    } else {
                         loadingIndicator.textContent = "";
                    }

                } else if (clear) {
                    loadingIndicator.textContent = "Aucun résultat trouvé pour cette recherche/ces filtres.";
                } else {
                    loadingIndicator.textContent = "Fin des résultats.";
                }

            } catch (error) {
                // En cas d'erreur de l'API (souvent due à des facettes mal formées ou un timeout)
                console.error("Erreur critique lors de la récupération des mods:", error);
                loadingIndicator.textContent = "Erreur de chargement. Veuillez réessayer. (Vérifiez les filtres)";
            } finally {
                isFetching = false;
            }
        }
        
        /**
         * Déclenche une nouvelle recherche complète après une petite pause.
         */
        let searchTimeout;
        function handleSearchOrFilterChange() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                // Réinitialise et recharge pour la nouvelle requête
                loadMods(true);
            }, 500); // 500ms de délai après la dernière frappe/changement de filtre
        }

        // Événements d'écoute pour la recherche et les filtres
        searchInput.addEventListener('input', handleSearchOrFilterChange);
        versionFilter.addEventListener('change', handleSearchOrFilterChange);
        loaderFilter.addEventListener('change', handleSearchOrFilterChange);
        typeFilter.addEventListener('change', handleSearchOrFilterChange);
        loadMoreButton.addEventListener('click', () => loadMods(false)); // Bouton de secours

        /**
         * Configure l'observateur d'intersection pour le chargement infini.
         */
        function setupInfiniteScroll() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // Si l'utilisateur voit la zone de chargement ET qu'aucune requête n'est déjà en cours
                    if (entry.isIntersecting && !isFetching && loadingIndicator.textContent === "") {
                        loadMods(false);
                    }
                });
            }, {
                rootMargin: '0px 0px 200px 0px', // Déclencher le chargement quand il reste 200px avant d'atteindre l'élément observé
                threshold: 0.1
            });

            // Nous observons le conteneur de chargement
            observer.observe(loadingArea);
        }

        // Initialisation: Chargement initial et mise en place de l'observateur
        window.onload = () => {
            loadMods(true); 
            setupInfiniteScroll(); 
        };

    </script>

</body>
</html>

